
<script src="face-api.js"></script>
<script src="commons.js"></script>

<video onplay="onPlay(this)" id="inputVideo" autoplay muted></video>
<canvas id="overlay" />
   

  <script>
    let scoreThreshold = 0.5
    let sizeType = '160'
    let modelLoaded = false

    let forwardTimes = []



    function onSizeTypeChanged(e, c) {
      sizeType = e.target.value
      $('#sizeType').val(sizeType)
    }

    async function onPlay(videoEl) {
      if(videoEl.paused || videoEl.ended || !modelLoaded)
        return false

      const { width, height } = faceapi.getMediaDimensions(videoEl)
      const canvas = $('#overlay').get(0)
      canvas.width = width
      canvas.height = height

      const forwardParams = {
        inputSize: parseInt(sizeType),
        scoreThreshold
      }

   
      result = await faceapi.tinyYolov2(videoEl, forwardParams)


      faceapi.drawDetection('overlay', result.map(det => det.forSize(width, height)))
      setTimeout(() => onPlay(videoEl))
    }
    
    
    
    async function loadNetWeights(uri) {
      return new Float32Array(await (await fetch(uri)).arrayBuffer())
    }
    
    
    
    async function run() {
      await faceapi.loadTinyYolov2Model('https://hpssjellis.github.io/beginner-tensorflowjs-examples-in-javascript/advanced-keras/face/muehler/models')
      modelLoaded = true

      const videoEl = $('#inputVideo').get(0)
      navigator.getUserMedia(
        { video: {} },
        stream => videoEl.srcObject = stream,
        err => console.error(err)
      )

      onPlay($('#inputVideo').get(0))
      $('#loader').hide()
    }

    $(document).ready(function() {
      renderNavBar('#navbar', 'tiny_yolov2_face_detection_webcam')

      const sizeTypeSelect = $('#sizeType')
      sizeTypeSelect.val(sizeType)
      sizeTypeSelect.on('change', onSizeTypeChanged)
      sizeTypeSelect.material_select()
      run()
    })
  </script>
</body>
</html>
